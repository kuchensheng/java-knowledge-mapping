#1 Kafka简介
Kafka是一款开源的、轻量级的、分布式、可分区和具有复制备份、基于Zookeeper协调管理的分布式流平台的功能强大的消息系统。它具有以下3个特性
* 能够允许发布和订阅流数据。
* 存储流数据时提供相应的容错机制。
* 当流数据到达时能够被及时处理。

##1.1 Kafka基本概念
### 1.1.1 主题
Kafka将一组消息抽象归纳为一个主题（Topic），也就是说，一个主题就是对消息的分类。生产者将消息推送到特定主题，消费者订阅主题或主题的某些分区进行消费。
### 1.1.2 消息
消息是Kafka通信的基本单位，由一个定长的消息头和一个可变的消息体构成。
### 1.1.3 分区和副本
*	Kafka将一组消息归纳为一个主题，而每个主题又被分为一个或多个分区。
	每个分区由一系列有序、不可变的消息组成，是由有序队列。每个分区在物理上对应一个文件夹，分区命名规则是**主题名称—[0-N]**,编号最大值为分区的总数减1。
*	每个分区又有一个至多个副本，分区的副本分布在集群的不同代理上，以提高可用性。
	分区使Kafka在并发处理上变得更加容易，理论上讲，分区数越多，吞吐量越高。但这也要根据实际情况而定。
	分区是Kafka保证消息被顺序消费以及对消息进行负载均衡的基础。
	Kafka只能保证一个分区内的消息的有序性，并不能保证跨分区消息的有序性。
	每条消息被追加到响应的分区中，是顺序写磁盘，因此效率很高。这是Kafka高吞吐率的一个重要保证。
	Kafka提供两种删除老数据的策略：一基于消息已存储的时间长度，二是基于分区大小。

### 1.1.4 Leader副本和Flower副本
由于Kafka副本的存在，就需要保证一个分区的多个副本之间数据的一致性，Kafka会选择该分区的一个副本作为Leader副本，而其他分区即为Follower副本，**只有Leader副本才负责处理客户端的读/写请求，Follower副本从Leader副本同步数据**。

### 1.1.5 偏移量
任何发布到分区的消息会被追加到日志文件的末尾，而每条消息在日志文件中的位置都会对应一个按序递增的偏移量。

### 1.1.6 日志段
一个日志又被划分为多个日志段（LogSegment），日志段是Kafka日志对象分片的最小单位。

### 1.1.7 代理（Broker）
我们将每一个Kafka实例称之为代理（Broker），通常也称之为Kafka服务器。每个代理都有唯一的标志Id

### 1.1.8 生产者

### 1.1.9 消费者

##1.2 Kafka特性
### 1.2.1 消息持久化
Kafka高度依赖于文件系统来存储和缓存消息。由于Kafka是基于JVM的，而Java对象内存是非常消耗内存的，鉴于以上因素，使用文件系统和依赖于页缓存的存储比维护一个内存的存储或者是应用其他结构来存储消息更有优势，因此Kafka选择以文件系统来存储数据。

### 1.2.2 高吞吐量
Kafka将数据写到磁盘，充分利用磁盘的顺序读写。同时Kafka在数据写入及数据同步采用了零拷贝技术，采用sendFile()函数调用。sendFile()函数是在两个文件描述符之间直接传递数据，完全在内核中操作，从而避免了内核缓冲区和用户缓冲区之间数据的拷贝，操作效率高。Kafka还支持数据压缩和批量发送，同时加上主题的分区技术，这一系列优化及实现方法使得Kafka具有很高的吞吐量。

###1.2.3 扩展性
Kafka依赖Zookeeper来对集群进行协调管理，这样使得Kafka更加容易进行水平扩展。

## 1.3 Kafka应用场景
+ 消息系统
+ 应用监控。利用Kafka采集应用程序和服务器健康相关指标，如CPU占用率、IO、内存、连接数、TPS、QPS等，然后将指标信息进行处理，从而构建一个具有监控仪表盘、曲线图等可视化监控系统。很多公司采用了Kafka与ELK（ElasticSearch、Logstash和Kibana）整合构建应用服务监控系统。
+ 网站用户行为跟踪。为了更好地了解用户行为，操作习惯，改善用户体验，进而对产品升级改进，将用户操作轨迹、内容等信息发送到Kafka集群上，再经过Hadoop、Spark等进行数据分析处理，生成响应的统计报告，为推荐系统推荐对象建模提供数据源，进而为每个用户进行个性化推荐。
+ 流处理
+ 持久化日志

# 2 Kafka核心组件
Kafka的核心组件包括：延迟操作组价、控制器、协调器、网络通信、日志管理器、副本管理器、动态配置管理器及心跳检测等
## 2.1 延迟操作组件
可以辅助Kafka其他组件完成相应的功能，比如协助客户端处理创建主题操作，协助协调器处理JoinGroupRequest和HeartbeatRequest请求，协助副本管理器处理ProduceRequest和FetchRequest请求。
### 2.1.1 DelayedOperation
DelayedOperation是一个基于事件启动有失效时间的TimerTask。